---
import Analytics from '@vercel/analytics/astro'
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Una Cara M√°s</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=EB+Garamond:wght@700&family=Zalando+Sans+Expanded:wght@800&display=swap" rel="stylesheet">
    <script>
      import { initStarfield } from '../scripts/starfield';
      (window as any).initStarfield = initStarfield;
    </script>
    <style>
      /* --- CORE RESET --- */
      * { box-sizing: border-box; }
      
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        font-family: system-ui, -apple-system, sans-serif;
        background-color: #000;
        cursor: none;
        overflow: hidden;
      }

      /* --- THE SNAP ENGINE --- */
      #snap-container {
        position: absolute;
        inset: 0;
        overflow-y: auto;
        overflow-x: hidden;
        scroll-snap-type: y mandatory;
        scroll-behavior: smooth;
        z-index: 100; 
        -webkit-overflow-scrolling: touch;
        pointer-events: auto; /* Scroller must be active to scroll */
      }

      .snap-trigger {
        height: 100vh;
        height: 100dvh;
        width: 100%;
        scroll-snap-align: start;
        scroll-snap-stop: always;
      }

      /* --- THE VISUAL LAYER --- */
      #visual-stack {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100vh;
        z-index: 1;
      }

      .panel {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        will-change: transform;
        transform: translateY(100%);
      }

      /* STACKING ORDER & THEMES */
      .panel-1 { z-index: 1; background: #000; transform: translateY(0%); }
      .panel-2 { z-index: 2; background: #000; }
      .panel-3 { z-index: 3; background: #0a0a0a; color: white; } 
      /* panel-4 removed */
      .panel-5 { z-index: 5; background: #fff; }
      .panel-6 { z-index: 6; background: #000; }

      .gallery-rail {
        display: flex;
        width: 200%;
        height: 100%;
        will-change: transform;
      }

      .gallery-section {
        width: 50%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
      }

      .panel-bg {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        pointer-events: none; 
      }

      .panel-bg img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .panel-1 .panel-bg img {
        object-fit: contain;
        transform: scale(1);
      }
      .panel-1 .panel-bg img.zoomed {
        animation: heroZoom 20s ease-in-out infinite;
      }

      @keyframes heroZoom {
        from { transform: scale(1); }
        to { transform: scale(var(--target-scale, 1.5)); }
      }

      .panel-bg video {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
      }

      .panel-content {
        position: relative;
        z-index: 2;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        pointer-events: auto; /* Content needs to be interactive */
      }

      /* --- CAROUSEL --- */
      .carousel-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
        touch-action: pan-y; /* Allow vertical scroll, block horizontal browser gestures */
      }

      .carousel-header {
        font-family: system-ui, -apple-system, sans-serif;
        font-weight: 700;
        font-size: 1.2rem; /* Smaller header */
        text-transform: none; /* Sentence case or title case */
        margin-bottom: 2rem;
        text-align: center;
        z-index: 10;
        letter-spacing: 0.02em;
        color: white;
      }

      .carousel-stage {
        position: relative;
        width: 100%;
        height: 60vh;
        display: flex;
        justify-content: center;
        align-items: center;
        perspective: 1000px;
      }

      .nav-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 2rem; /* Smaller arrows */
        color: white;
        background: transparent;
        border: none;
        cursor: pointer;
        z-index: 20;
        padding: 1rem;
        opacity: 1; /* Fully visible */
        transition: opacity 0.3s;
        font-family: sans-serif;
        user-select: none;
        pointer-events: auto;
      }
      .nav-arrow:hover { opacity: 0.7; }
      .nav-prev { left: 28%; } /* Position closer to center */
      .nav-next { right: 28%; }

      .carousel-item {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%); /* Default center */
        width: 45vh; /* Increase size slightly */
        transition: all 0.6s cubic-bezier(0.25, 1, 0.5, 1);
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        pointer-events: auto;
      }

      /* Modifier classes applied by JS */
      .carousel-item.active {
        z-index: 10;
        left: 50%;
        transform: translate(-50%, -50%) scale(1.2);
        opacity: 1;
      }

      .carousel-item.prev {
        z-index: 5;
        left: 15%; /* Push to the left edge */
        transform: translate(-50%, -50%) scale(0.9);
        opacity: 0.6;
        filter: grayscale(0%); /* Keep color but dim if needed, reference suggests full color */
      }

      .carousel-item.next {
        z-index: 5;
        left: 85%; /* Push to the right edge */
        transform: translate(-50%, -50%) scale(0.9);
        opacity: 0.6;
        filter: grayscale(0%);
      }

      .carousel-item.hidden {
        opacity: 0;
        pointer-events: none;
        transform: translate(-50%, -50%) scale(0.5);
      }
       /* We can calculate specific hidden positions in JS or use generic hidden */

      .poster-media { 
        position: relative; 
        aspect-ratio: 1 / 1; 
        width: 100%;
        overflow: hidden; 
        background: #111;
        pointer-events: auto;
        border: none;
        box-shadow: 0 20px 50px rgba(0,0,0,0.8); /* Darker shadow */
      }

      .poster-media img { 
        width: 100%; 
        height: 100%; 
        object-fit: cover; 
        pointer-events: none;
      }

      .poster-video { 
        position: absolute; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        object-fit: cover; 
        display: none;
        z-index: 10;
        pointer-events: none;
      }

      .poster-title {
        margin-top: 2rem;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 0.8rem;
        text-align: center;
        opacity: 0;
        transition: opacity 0.3s;
        color: white;
        text-transform: none; /* Keep natural case for title or minimal caps */
        letter-spacing: 0.02em;
        font-weight: 400;
      }

      .carousel-item.active .poster-title {
        opacity: 1;
      }


      .impact {
        font-family: Impact, sans-serif;
        font-weight: 900;
      }

      .zalando {
        font-family: 'Zalando Sans Expanded', sans-serif;
        font-weight: 800;
        letter-spacing: 0.02em;
      }

      .garamond {
        font-family: 'EB Garamond', serif;
        font-weight: 700;
        font-style: normal;
        text-transform: none;
      }


      /* UI ELEMENTS */
      .fixed-ui {
        position: fixed;
        top: 0; left: 0; width: 100%;
        padding: 2rem;
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        pointer-events: none;
        color: white;
        mix-blend-mode: difference;
        font-family: monospace;
        text-transform: uppercase;
      }

      .fixed-ui.panel-1-active {
        mix-blend-mode: normal;
      }

      .fixed-ui.panel-1-active .fixed-center {
        text-shadow: 0 0 10px rgba(0,0,0,0.8);
      }

      .fixed-center { position: absolute; left: 50%; transform: translateX(-50%); font-size: 1.2rem; font-weight: 900; }

      .unmute-button {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 1rem 2rem;
        font-size: 0.75rem;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        cursor: pointer;
        z-index: 200;
        position: fixed;
        bottom: 8vh;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      .unmute-button.visible { opacity: 1; pointer-events: auto; }

      #custom-cursor {
        position: fixed; top: 0; left: 0;
        width: 8px; height: 8px;
        background: white;
        border-radius: 50%;
        pointer-events: none;
        mix-blend-mode: difference;
        z-index: 10001;
        transform: translate(-50%, -50%);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: width 0.3s, height 0.3s, border-radius 0.3s;
      }

      #custom-cursor span {
        font-family: Impact, sans-serif;
        font-size: 8px;
        color: black;
        opacity: 0;
        transition: opacity 0.2s;
        text-transform: uppercase;
      }

      #custom-cursor.active {
        width: 15px;
        height: 15px;
      }

      @media (max-width: 900px) {
        .poster-grid { grid-template-columns: repeat(2, 1fr); width: 90%; }
      }
    </style>
  </head>

  <body>
    <div class="fixed-ui">
      <div class="fixed-left">
        <div id="phx-block" style="text-align:left;">
          <div id="phx-time">PHX --:--</div>
          <div id="phx-weather" style="font-size:0.8rem; margin-top:4px;">--</div>
        </div>
      </div>
      <div class="fixed-center">KOVA PARKER</div>
      <div class="fixed-right" id="live-clock">-- -- --</div>
    </div>
    <Analytics/>

    <div id="custom-cursor"></div>

    <button class="unmute-button" id="unmute-button">UNMUTE</button>

    <div id="snap-container">
      <div class="snap-trigger"></div>
      <div class="snap-trigger"></div>
      <div class="snap-trigger"></div>
      <div class="snap-trigger"></div>
      <div class="snap-trigger"></div>
      <div class="snap-trigger"></div>
    </div>

    <div id="visual-stack">
      <!-- Panel 1: Hero -->
      <section class="panel panel-1" id="p1">
        <div class="panel-bg"><img id="hero-img" src="/images/gemini.png" onerror="this.src='https://placehold.co/1920x1080/000/fff?text=UNA+CARA+MAS'"></div>
        <div class="panel-content" style="justify-content: flex-end; padding-bottom: 2rem;">
          <div style="text-align: center;">
            <h1 style="color:white; font-size: 1vw; letter-spacing: 0em; text-transform: uppercase; mix-blend-mode: difference; margin: 0;">Una Cara M√°s</h1>
            <p style="color:white; font-size: 0.8vw; letter-spacing: 0em; text-transform: uppercase; mix-blend-mode: difference; margin: 10px 0 0 0;">DROPPED ON FEBRUARY 28, 2026</p>
          </div>
        </div>
      </section>

      <!-- Panel 2: Promo Video -->
      <section class="panel panel-2" id="p2">
        <div class="panel-bg">
          <video id="promo-video" playsinline loop muted preload="metadata">
            <source src="https://files.catbox.moe/kkgy0w.mov" type="video/mp4">
          </video>
        </div>
      </section>

      <!-- Panel 3: Track Carousel -->
      <section class="panel panel-3" id="p3">
        <div class="carousel-container">
          <div class="carousel-header">Una Cara M√°s Official Tracklist</div>
          
          <div class="carousel-stage" id="carousel-stage">
            <button class="nav-arrow nav-prev" id="prev-btn">&lt;</button>
            <button class="nav-arrow nav-next" id="next-btn">&gt;</button>

            <!-- Items -->
            <!-- 1 -->
            <div class="carousel-item active">
              <div class="poster-media">
                <img src="/images/goboy.png" loading="eager" decoding="sync">
                <video class="poster-video" src="/videos/goboy.mp4" muted loop playsinline preload="auto"></video>
              </div>
              <div class="poster-title">GO BOY!!!</div>
            </div>
            <!-- 2 -->
            <div class="carousel-item next">
               <div class="poster-media">
                <img src="/images/manana.png" loading="eager" decoding="sync">
                <video class="poster-video" src="/videos/manana.mp4" muted loop playsinline preload="auto"></video>
              </div>
              <div class="poster-title">Ma√±ana se Acaba el üåé</div>
            </div>
            <!-- 3 -->
            <div class="carousel-item">
               <div class="poster-media">
                <img src="/images/undia.png" loading="eager" decoding="sync">
                <video class="poster-video" src="/videos/undia.mp4" muted loop playsinline preload="auto"></video>
              </div>
              <div class="poster-title">Un D√≠a Normalllll</div>
            </div>
            <!-- 4 -->
            <div class="carousel-item">
               <div class="poster-media">
                <img src="/images/gioia.png" loading="eager" decoding="sync">
                <video class="poster-video" src="/videos/gioia.mp4" muted loop playsinline preload="auto"></video>
              </div>
              <div class="poster-title">GIOIAAAA</div>
            </div>
            <!-- 5 -->
            <div class="carousel-item">
               <div class="poster-media">
                <img src="/images/togya.png" loading="eager" decoding="sync">
                <video class="poster-video" src="/videos/togya.mp4" muted loop playsinline preload="auto"></video>
              </div>
              <div class="poster-title">TOGYAAAA</div>
            </div>
            <!-- 6 -->
            <div class="carousel-item">
               <div class="poster-media">
                <img src="/images/redrocks.png" loading="eager" decoding="sync">
                <video class="poster-video" src="/videos/redrocks.mp4" muted loop playsinline preload="auto"></video>
              </div>
              <div class="poster-title">Kova at Red Rockssss</div>
            </div>
            <!-- 7 -->
            <div class="carousel-item">
               <div class="poster-media">
                <img src="/images/obsesivo.png" loading="eager" decoding="sync">
                <video class="poster-video" src="/videos/obsesivo.mp4" muted loop playsinline preload="auto"></video>
              </div>
              <div class="poster-title">OBSESIVO COMPULSIVO.</div>
            </div>
            <!-- 8 -->
            <div class="carousel-item">
               <div class="poster-media">
                <img src="/images/yono.png" loading="eager" decoding="sync">
                <video class="poster-video" src="/videos/yono.mp4" muted loop playsinline preload="auto"></video>
              </div>
              <div class="poster-title">yo no soy tu paiiii</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Panel 4 Removed (Merged) -->

      <!-- Panel 5: Bio -->
      <section class="panel panel-5" id="p5">
        <div class="panel-content" style="position: relative; width: 100%; height: 100%;">
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 2rem;">
            <div style="text-align: center;">
              <img src="/images/kova-parker.jpeg" style="max-height: 70vh" onerror="this.src='https://placehold.co/800x800/EEE/111?text=Kova+Portrait'">
              <h2 style="color:black; margin-top:20px; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.0em; text-transform: uppercase;">KOVA PARKER</h2>
            </div>
            <div style="text-align: center;" id="documentary-image">
              <div style="position: relative; display: inline-block;">
                <img src="/images/kovastreet.jpeg" style="max-height: 70vh" onerror="this.src='https://placehold.co/800x800/EEE/111?text=Kova+Street'">
                <div class="documentary-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;">
                  <p style="color: white; font-size: 0.8rem; font-weight: 400; letter-spacing: 0.00em; text-transform: uppercase; text-align: center; margin: 0; padding: 1rem;">DOCUMENTARY BEING RELEASED<br>MARCH 22, 2026</p>
                </div>
              </div>
              <h2 style="color:black; margin-top:20px; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.0em; text-transform: uppercase;">UNA CARA M√ÅS</h2>
            </div>
          </div>
          <p style="position: absolute; bottom: 3.5rem; left: 50%; transform: translateX(-50%); color:black; margin: 0; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.0em; text-transform: uppercase;">(DISCOVER)</p>
        </div>
      </section>

      <!-- Panel 6: Starfield Animation -->
      <section class="panel panel-6" id="p6">
        <canvas id="starfield" style="display: block; width: 100%; height: 100%;"></canvas>
      </section>
    </div>

   <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 0. HERO ZOOM LOGIC
      const heroImg = document.getElementById('hero-img') as HTMLImageElement | null;
      if (heroImg) {
        const startZoom = () => {
          const winW = window.innerWidth;
          const winH = window.innerHeight;
          const imgW = heroImg.naturalWidth;
          const imgH = heroImg.naturalHeight;

          if (imgW && imgH) {
            // Calculate scale to go from 'contain' to 'cover'
            const scaleX = winW / imgW;
            const scaleY = winH / imgH;
            
            // contain scale is min(scaleX, scaleY)
            // cover scale is max(scaleX, scaleY)
            const targetScale = Math.max(scaleX, scaleY) / Math.min(scaleX, scaleY);
            
            heroImg.style.setProperty('--target-scale', targetScale.toString());
            // Force reflow
            void heroImg.offsetWidth;
            heroImg.classList.add('zoomed');
          }
        };

        if (heroImg.complete) startZoom();
        else heroImg.addEventListener('load', startZoom);

        window.addEventListener('resize', startZoom);
      }

      const scroller = document.getElementById('snap-container') as HTMLElement | null;
      // panels array is no longer used for strict loop logic, but kept for element refs if needed
      // const panels = ... 
      
      const cursor = document.getElementById('custom-cursor') as HTMLElement | null;
      const promoVideo = document.getElementById('promo-video') as HTMLVideoElement | null;
      const unmuteBtn = document.getElementById('unmute-button') as HTMLButtonElement | null;
      const fixedUi = document.querySelector('.fixed-ui');
      const galleryRail = document.getElementById('gallery-rail');
      
      const p2 = document.getElementById('p2');
      const p3 = document.getElementById('p3');
      const p5 = document.getElementById('p5');
      const p6 = document.getElementById('p6');

      // --- CAROUSEL LOGIC ---
      const carouselItems = document.querySelectorAll('.carousel-item');
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      let currentIndex = 0;

      function updateCarousel() {
        const total = carouselItems.length;
        carouselItems.forEach((item, index) => {
          item.className = 'carousel-item'; // Reset
          
          if (index === currentIndex) {
            item.classList.add('active');
            togglePosterVideo(item as HTMLElement, true);
          } else if (index === currentIndex - 1) {
            item.classList.add('prev');
            togglePosterVideo(item as HTMLElement, false);
          } else if (index === currentIndex + 1) {
            item.classList.add('next');
            togglePosterVideo(item as HTMLElement, false);
          } else {
            item.classList.add('hidden');
            togglePosterVideo(item as HTMLElement, false);
          }
        });

        // Hide buttons at ends
        if (prevBtn) prevBtn.style.opacity = currentIndex === 0 ? '0' : '1';
        if (prevBtn) (prevBtn as HTMLElement).style.pointerEvents = currentIndex === 0 ? 'none' : 'auto';
        if (nextBtn) nextBtn.style.opacity = currentIndex === total - 1 ? '0' : '1';
        if (nextBtn) (nextBtn as HTMLElement).style.pointerEvents = currentIndex === total - 1 ? 'none' : 'auto';
      }

      if (carouselItems.length > 0) {
        updateCarousel();
        
        const showNext = () => {
          if (currentIndex < carouselItems.length - 1) {
            currentIndex++;
            updateCarousel();
          }
        };

        const showPrev = () => {
          if (currentIndex > 0) {
            currentIndex--;
            updateCarousel();
          }
        };

        if (nextBtn) nextBtn.addEventListener('click', showNext);
        if (prevBtn) prevBtn.addEventListener('click', showPrev);

        document.addEventListener('keydown', (e) => {
          // Only navigate if we are looking at the carousel (Panel 3 visible-ish)
          if (!scroller) return;
          const st = scroller.scrollTop;
          const vh = window.innerHeight;
          // Rough check if Panel 3 is on screen (starts at 1vh, covers up to 3vh)
          if (st > vh * 0.5 && st < vh * 3.5) {
            if (e.key === 'ArrowRight') showNext();
            if (e.key === 'ArrowLeft') showPrev();
          }
        });

        // Add manual click handling for carousel buttons through the scroller overlay
        scroller?.addEventListener('click', (e) => {
             const x = e.clientX; 
             const y = e.clientY;
             scroller.style.pointerEvents = 'none';
             const hit = document.elementFromPoint(x, y);
             scroller.style.pointerEvents = 'auto';
             
             if (hit) {
               if (hit.closest('#prev-btn')) showPrev();
               if (hit.closest('#next-btn')) showNext();
             }
        });

        // --- SWIPE / DRAG / WHEEL LOGIC ---
        let startX = 0;
        let startY = 0;
        let startTime = 0;

        scroller?.addEventListener('pointerdown', (e) => {
          startX = e.clientX;
          startY = e.clientY;
          startTime = Date.now();
        }, { passive: true });

        scroller?.addEventListener('pointerup', (e) => {
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          const dt = Date.now() - startTime;
          const threshold = 30; // Slightly lower threshold
          const timeThreshold = 500;

          if (dt < timeThreshold && Math.abs(dx) > threshold && Math.abs(dx) > Math.abs(dy)) {
            const st = scroller.scrollTop;
            const vh = window.innerHeight;
            // Broader check for Panel 3
            if (st > vh * 0.5 && st < vh * 3.5) {
              if (dx < 0) showNext();
              else showPrev();
            }
          }
        }, { passive: true });

        // Wheel support (Trackpad horizontal swipe)
        let lastWheelTime = 0;
        scroller?.addEventListener('wheel', (e) => {
          // If moving horizontally more than vertically
          if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
            const st = scroller.scrollTop;
            const vh = window.innerHeight;
            if (st > vh * 0.5 && st < vh * 3.5) {
              const now = Date.now();
              if (now - lastWheelTime < 400) return; // Debounce

              if (Math.abs(e.deltaX) > 10) {
                if (e.deltaX > 0) showNext();
                else showPrev();
                lastWheelTime = now;
              }
            }
          }
        }, { passive: true });
      }
      
      let mx = 0, my = 0, cx = 0, cy = 0;
      let lastHoveredMedia: HTMLElement | null = null;
      let lastScrollTop = -1;
      let tick = 0;

      // Initialize panel-1-active state
      fixedUi?.classList.add('panel-1-active');

      // 1. TRACK MOUSE (Optimized: Removed heavy logic)
      document.addEventListener('mousemove', (e) => {
        mx = e.clientX;
        my = e.clientY;
      });

      function togglePosterVideo(container: HTMLElement, play: boolean) {
        const v = container.querySelector('.poster-video') as HTMLVideoElement | null;
        if (!v) return;
        if (play) {
          v.style.display = 'block';
          v.currentTime = 0;
          v.play().catch(() => {});
        } else {
          v.pause();
          v.style.display = 'none';
        }
      }

      // 2. MASTER RENDER LOOP (Handles Scroll & Cursor & Hover)
      function renderLoop() {
        requestAnimationFrame(renderLoop);

        // A. CURSOR INTERPOLATION
        if (cursor) {
          cx += (mx - cx) * 0.15;
          cy += (my - cy) * 0.15;
          cursor.style.transform = `translate(${cx}px, ${cy}px) translate(-50%, -50%)`;
        }
        
        // B. SCROLL & ANIMATION LOGIC
        if (scroller) {
          const scrollTop = scroller.scrollTop;
          
          // Only update if scroll changed or first run
          if (Math.abs(scrollTop - lastScrollTop) > 0.5 || lastScrollTop === -1) {
            lastScrollTop = scrollTop;
            const vh = window.innerHeight;

            // --- UI STATES ---
            if (scrollTop < vh) {
              if (!fixedUi?.classList.contains('panel-1-active')) fixedUi?.classList.add('panel-1-active');
            } else {
              if (fixedUi?.classList.contains('panel-1-active')) fixedUi?.classList.remove('panel-1-active');
            }

            // --- PANEL ANIMATION LOGIC ---
            // Range 0 -> 1vh : Panel 2 enters over Panel 1
            if (p2) {
              const start = 0; const end = vh;
              if (scrollTop <= start) p2.style.transform = `translateY(100%)`;
              else if (scrollTop >= end) p2.style.transform = `translateY(0%)`;
              else {
                const p = (scrollTop - start) / vh;
                p2.style.transform = `translateY(${100 - (p * 100)}%)`;
              }
            }

            // Range 1vh -> 2vh : Panel 3 enters over Panel 2
            if (p3) {
              const start = vh; const end = 2 * vh;
              if (scrollTop <= start) p3.style.transform = `translateY(100%)`;
              else if (scrollTop >= end) p3.style.transform = `translateY(0%)`;
              else {
                const p = (scrollTop - start) / vh;
                p3.style.transform = `translateY(${100 - (p * 100)}%)`;
              }
            }



            // Range 3vh -> 4vh : Panel 5 enters over Panel 3
            if (p5) {
              const start = 3 * vh; const end = 4 * vh;
              if (scrollTop <= start) p5.style.transform = `translateY(100%)`;
              else if (scrollTop >= end) p5.style.transform = `translateY(0%)`;
              else {
                const p = (scrollTop - start) / vh;
                p5.style.transform = `translateY(${100 - (p * 100)}%)`;
              }
            }

            // Range 4vh -> 5vh : Panel 6 enters over Panel 5
            if (p6) {
              const start = 4 * vh; const end = 5 * vh;
              if (scrollTop <= start) p6.style.transform = `translateY(100%)`;
              else if (scrollTop >= end) p6.style.transform = `translateY(0%)`;
              else {
                const p = (scrollTop - start) / vh;
                p6.style.transform = `translateY(${100 - (p * 100)}%)`;
              }
            }

            const isPromoVisible = scrollTop >= vh - 100 && scrollTop < vh * 2 - 100;
            if (isPromoVisible) {
              if (promoVideo && promoVideo.paused) promoVideo.play().catch(() => {});
              if (unmuteBtn && document.body.contains(unmuteBtn)) unmuteBtn.classList.add('visible');
            } else {
              if (promoVideo && !promoVideo.paused) promoVideo.pause();
              if (unmuteBtn) unmuteBtn.classList.remove('visible');
            }
          }
        }

        // C. HOVER DETECTION (Throttled)
        // Check every 6 frames (approx 10 times per second @ 60fps)
        tick++;
        if (tick % 6 === 0 && scroller) {
          // Only check if we are interacting with the gallery (roughly scrolled past 0.5 screen height)
          if (lastScrollTop > window.innerHeight * 0.5) {
             scroller.style.pointerEvents = 'none';
             const hoveredElement = document.elementFromPoint(mx, my);
             scroller.style.pointerEvents = 'auto'; // This toggle is expensive, hence throttling

             const posterMedia = hoveredElement?.closest('.poster-media') as HTMLElement | null;
             const overDocImg = hoveredElement?.closest('#documentary-image') as HTMLElement | null;
             const overStarfield = hoveredElement?.closest('#starfield') as HTMLElement | null;

             if (cursor) {
               if (overDocImg || posterMedia || overStarfield) {
                 cursor.classList.add('active');
               } else {
                 cursor.classList.remove('active');
               }
             }

             // Visual feedback for the documentary image itself
             if (overDocImg) {
               overDocImg.style.transform = 'scale(1.02)';
               overDocImg.style.transition = 'transform 0.3s ease';
             } else {
               const allDocImgs = document.querySelectorAll('#documentary-image');
               allDocImgs.forEach(el => (el as HTMLElement).style.transform = 'scale(1)');
             }
          }
        }
      }
      renderLoop();

      // 4. UNMUTE LOGIC
      // When user clicks UNMUTE we want the button to disappear and keep the video unmuted.
      unmuteBtn?.addEventListener('click', () => {
        if (promoVideo && unmuteBtn) {
          // Force unmute
          promoVideo.muted = false;

          // Hide visually (fade) then remove from DOM so it can't reappear on scroll
          unmuteBtn.classList.remove('visible');
          unmuteBtn.style.transition = 'opacity 0.3s ease';
          unmuteBtn.style.opacity = '0';
          setTimeout(() => {
            try { unmuteBtn.remove(); } catch (e) { /* ignore */ }
          }, 300);
        }
      });

      // 5. CLOCK & WEATHER UPDATER (PHX)
      function getWeatherDescription(code: number) {
        // Map Open-Meteo weather codes to human-friendly text
        if (code === 0) return 'Clear';
        if (code === 1 || code === 2 || code === 3) return 'Partly cloudy';
        if (code === 45 || code === 48) return 'Fog';
        if (code === 51 || code === 53 || code === 55) return 'Drizzle';
        if (code === 56 || code === 57) return 'Freezing drizzle';
        if (code === 61 || code === 63 || code === 65) return 'Rain';
        if (code === 66 || code === 67) return 'Freezing rain';
        if (code === 71 || code === 73 || code === 75) return 'Snow';
        if (code === 77) return 'Snow grains';
        if (code === 80 || code === 81 || code === 82) return 'Showers';
        if (code === 85 || code === 86) return 'Snow showers';
        if (code === 95 || code === 96 || code === 99) return 'Thunderstorm';
        return 'Unknown';
      }

      async function fetchPhxWeather() {
        const phxWeatherEl = document.getElementById('phx-weather');
        try {
          // Phoenix, AZ coordinates
          const lat = 33.4484; const lon = -112.0740;
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=America/Phoenix`;
          const res = await fetch(url);
          if (!res.ok) throw new Error('weather fetch failed');
          const data = await res.json();
          const cw = data.current_weather;
          if (cw && typeof cw.temperature === 'number') {
            const c = cw.temperature; // Celsius
            const f = Math.round((c * 9) / 5 + 32);
            const desc = getWeatherDescription(cw.weathercode);
            if (phxWeatherEl) phxWeatherEl.innerText = `${f}¬∞F ¬∑ ${desc}`;
          } else {
            if (phxWeatherEl) phxWeatherEl.innerText = `‚Äî`;
          }
        } catch (e) {
          if (phxWeatherEl) phxWeatherEl.innerText = `‚Äî`;
        }
      }

      function updateClock() {
        const now = new Date();
        const fmt: Intl.DateTimeFormatOptions = { hour: '2-digit', minute: '2-digit', hour12: false };
        const phxTime = document.getElementById('phx-time');
        const liveClock = document.getElementById('live-clock');

        if (phxTime) {
          phxTime.innerText = "PHX, AZ " + now.toLocaleTimeString('en-US', { ...fmt, timeZone: 'America/Phoenix' });
        }
        if (liveClock) {
          const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
          liveClock.innerText = `${months[now.getMonth()]} ${now.getDate()} ${now.getFullYear()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
        }
      }

      // Refresh clock every second and weather every 10 minutes
      setInterval(updateClock, 1000); updateClock();
      fetchPhxWeather();
      setInterval(fetchPhxWeather, 10 * 60 * 1000);

      // 6. DOCUMENTARY IMAGE CLICK HANDLER
      const documentaryImage = document.getElementById('documentary-image');
      const documentaryOverlay = documentaryImage?.querySelector('.documentary-overlay') as HTMLElement | null;
      
      scroller?.addEventListener('click', () => {
        if (!scroller || !documentaryImage || !documentaryOverlay) return;
        
        // Use the same trick as hover detection to see what's under the scroller
        scroller.style.pointerEvents = 'none';
        const hit = document.elementFromPoint(mx, my);
        scroller.style.pointerEvents = 'auto';
        
        if (hit && documentaryImage.contains(hit)) {
          const isVisible = documentaryOverlay.style.opacity === '1';
          documentaryOverlay.style.opacity = isVisible ? '0' : '1';
        }
      });

      // 7. STARFIELD ANIMATION (Panel 6)
      if (typeof (window as any).initStarfield === 'function') {
        (window as any).initStarfield('starfield', 'snap-container');
      }
    });
   </script>
  </body>
</html>